<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>2025 Events Quiz</title>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <style>
    body { margin:0; font-family:Arial,sans-serif; background:#f2f2f2; }
    .screen { display:none; min-height:100vh; padding:16px; }
    .active { display:block; }

    /* Entry dialog */
    .dialog {
      max-width:320px;
      margin:100px auto;
      background:#fff;
      padding:24px 20px 28px;
      border-radius:16px;
      box-shadow:0 6px 18px rgba(0,0,0,.15);
      text-align:center;
      box-sizing:border-box;
    }
    .dialog h2 { margin:0 0 8px; }
    .dialog p { margin:0 0 16px; color:#555; }

    input, button {
      width:100%;
      box-sizing:border-box;
      padding:12px;
      font-size:16px;
      margin-top:12px;
    }

    button {
      border:none;
      border-radius:12px;
      background:#007bff;
      color:white;
      font-weight:bold;
    }

    .panel {
      background:white;
      padding:14px;
      border-radius:12px;
      margin-bottom:14px;
    }

    .user-row {
      display:flex;
      justify-content:space-between;
      font-size:14px;
      margin-top:6px;
    }

    .score { font-weight:bold; text-align:center; margin-bottom:10px; }

    .progress {
      height:10px;
      background:#ddd;
      border-radius:6px;
      overflow:hidden;
      margin-bottom:12px;
    }
    .progress-bar {
      height:100%;
      width:0%;
      background:#28a745;
      transition:width .3s;
    }

    .choice { margin-top:10px; }
  </style>
</head>
<body>

<!-- SCREEN 1 -->
<div id="screen1" class="screen active">
  <div class="dialog">
    <h2>Welcome to the Collopy Family 2025 Quiz</h2>
    <p>Enter your name to begin</p>
    <input id="username" placeholder="Your name" />
    <button onclick="enterApp()">Start Quiz</button>
  </div>
</div>

<!-- SCREEN 2 -->
<div id="screen2" class="screen">

  <div class="panel">
    <strong>Current Users</strong>
    <div id="userList"></div>
  </div>

  <div class="score" id="scoreDisplay">Score: 0/0</div>
  <div class="progress"><div id="progressBar" class="progress-bar"></div></div>

  <div id="questionPanel" class="panel"></div>

  <div class="panel">
    <strong>Users With Correct Answers</strong>
    <div id="winnerList"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAYylkF10iLxdLh0l2bezBfGQqTXeZ0y7o",
  authDomain: "erc2025quiz.firebaseapp.com",
  databaseURL: "https://erc2025quiz-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "erc2025quiz",
  storageBucket: "erc2025quiz.firebasestorage.app",
  messagingSenderId: "979651276106",
  appId: "1:979651276106:web:cf5c56ad87f559b2f765b3",
  measurementId: "G-Y33C1Z2YQR"
};

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const usersRef = db.ref('users');
  const winnersRef = db.ref('winners');

  let userKey = null;
  let currentUser = '';
  let currentQuestionIndex = 0;
  let answeredCount = 0;
  let correctCount = 0;
  let hasWon = false;

  const INACTIVITY_LIMIT = 5 * 60 * 1000;

  const questions = [
      {
          q: 'What are Cecilys favourite numbers this year?',
          choices: ['6516', '2 .. 3', '4 ...5 ', '6 ...7'],
          answer: 3 // Zadie Smith
      },
      {
          q: 'What does a sensible person do after a haircut?',
          choices: ['Change clothes', 'Shower', 'Look in the mirror', 'Hang their hair in the xmas tree'],
          answer: 3 // Jodie Whittaker
      },
      {
          q: 'Aggregated weekly running distance at 87 Esmond Road',
          choices: ['1km', '5km', '15km', '100m'],
          answer: 2 // Hung parliament (Note: This is a projected/potential 2025 event based on current political climate)
      }
  ];

  function enterApp() {
    const name = document.getElementById('username').value.trim();
    if (!name) return;

    currentUser = name;
    userKey = usersRef.push({ name, score:'0/0', lastActive:Date.now() }).key;
    usersRef.child(userKey).onDisconnect().remove();

    document.getElementById('screen1').classList.remove('active');
    document.getElementById('screen2').classList.add('active');

    showQuestion();
    startHeartbeat();
  }

  function startHeartbeat() {
    setInterval(() => {
      if (userKey) {
        usersRef.child(userKey).update({ lastActive:Date.now(), score:`${correctCount}/${answeredCount}` });
      }
    }, 30000);
  }

  function showQuestion() {
    const panel = document.getElementById('questionPanel');
    panel.innerHTML = '';

    if (currentQuestionIndex >= questions.length) {
      panel.innerHTML = '<strong>Quiz complete!</strong>';
      return;
    }

    const q = questions[currentQuestionIndex];
    panel.innerHTML = `<strong>Question ${currentQuestionIndex + 1} of ${questions.length}</strong><br>${q.q}`;

    q.choices.forEach((c,i) => {
      const btn = document.createElement('button');
      btn.className = 'choice';
      btn.textContent = c;
      btn.onclick = () => answerQuestion(i);
      panel.appendChild(btn);
    });

    updateProgress();
  }

  function answerQuestion(choiceIndex) {
    answeredCount++;

    if (choiceIndex === questions[currentQuestionIndex].answer) {
      correctCount++;
      if (!hasWon) {
        winnersRef.child(currentUser).set({ score:`${correctCount}/${answeredCount}` });
        hasWon = true;
      } else {
        winnersRef.child(currentUser).update({ score:`${correctCount}/${answeredCount}` });
      }
    }

    updateScore();
    currentQuestionIndex++;
    showQuestion();
  }

  function updateScore() {
    document.getElementById('scoreDisplay').textContent = `Score: ${correctCount}/${answeredCount}`;
    if (userKey) usersRef.child(userKey).update({ score:`${correctCount}/${answeredCount}` });
  }

  function updateProgress() {
    document.getElementById('progressBar').style.width = ((currentQuestionIndex / questions.length) * 100) + '%';
  }

  usersRef.on('value', snap => {
    const list = document.getElementById('userList');
    list.innerHTML = '';
    const now = Date.now();

    snap.forEach(c => {
      const u = c.val();
      if (!u || !u.name || !u.score) return;

      // Remove inactive users and their winner entry
    if (now - u.lastActive > INACTIVITY_LIMIT) {
      usersRef.child(c.key).remove();
      winnersRef.child(u.name).remove();  // <-- REMOVE winner for inactive user
      return;
    }

      const div = document.createElement('div');
      div.className = 'user-row';
      div.innerHTML = `<span>${u.name}</span><span>${u.score}</span>`;
      list.appendChild(div);
    });
  });

  winnersRef.on('value', snap => {
    const list = document.getElementById('winnerList');
    list.innerHTML = '';

    snap.forEach(c => {
      const w = c.val();
      if (!w || !w.score) return;
      const div = document.createElement('div');
      div.className = 'user-row';
      div.innerHTML = `<span>${c.key}</span><span>${w.score}</span>`;
      list.appendChild(div);
    });
  });
</script>

</body>
</html>
